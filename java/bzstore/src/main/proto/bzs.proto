syntax = "proto3";

package protocol;

option java_package = "edu.ucsc.edgelab.db.bzs";

service BZStore {
    rpc Commit (Transaction) returns (TransactionResponse);
    rpc ROCommit (ROTransaction) returns (ROTransactionResponse);
    rpc ReadOperation (Read) returns (ReadResponse);
}

service Cluster {
    rpc CommitPrepare (Transaction) returns (TransactionResponse);
    rpc Commit (Transaction) returns (TransactionResponse);
    rpc ReadOperation (Read) returns (ReadResponse);
    rpc Abort (Transaction) returns (TransactionResponse);
}

service Replica {
    rpc Forward (Transaction) returns (TransactionResponse);
    rpc ForwardROT (ROTransaction) returns (ROTransactionResponse);
}

service PKIService {
    rpc GetPublicKey (KeyType) returns (Key);    // Possible interface to retrieve digital signatures from nodes.
    rpc GetPrivateKey (KeyType) returns (Key);    // Possible interface to retrieve digital signatures from nodes
}

message KeyType {
    string algorithm = 1;
}

message Key {
    string key =1;
    string type = 2;
}

message TransactionBatch {
    repeated Transaction transactions = 1;
    repeated ROTransaction rotransaction = 2;
    //    BFTCommit bftCommit = 3;
    string ID = 3;
    Operation operation = 4;
}

message TransactionBatchResponse {
    repeated TransactionResponse responses = 1;
    repeated ROTransactionResponse readresponses = 2;
    //    BFTCommitResponse bftCommitResponse = 3;
    string ID = 3;
    Operation operation = 4;
}

message BFTCommit {
    repeated TransactionResponse transactions = 1;
    int32 ID = 2;
}
message BFTCommitResponse {
    repeated TransactionResponse responses = 1;
    int32 ID = 2;
}

enum TransactionStatus {
    COMMITTED = 0;
    ABORTED = 1;
    PREPARED = 2;
    TIMEOUT = 3;
    FAILURE = 4;
}

enum OperationStatus {
    FAILED = 0; // To be removed. Kept for backward compatibility (for now). Use "ABORTED" instead.
    SUCCESS = 1;
    INVALID = 2;
    COMMIT_SUCCESS = 3;
    ABORT = 4;
    PREPARE_SUCCESS = 5;
}

enum Operation {
    BFT_PREPARE = 0;
    BFT_COMMIT = 1;
    BFT_ABORT = 2;
}

message Write {
    string key = 1;
    string value = 2;
    int32 clusterID = 3;
    int32 replicaID = 4;
}

message WriteResponse {
    string key = 1;
    string value = 2;
    int64 version = 3;
    string responseDigest = 4;
    OperationStatus status = 5;
    int32 clusterID = 6;
    int32 replicaID = 7;
}

message Read {
    string key = 1;
    int32 clusterID = 2;
    int32 replicaID = 3;
}

message ReadResponse {
    string key = 1;
    string value = 2;
    int64 version = 3;
    string responseDigest = 4;
    OperationStatus status = 5;
    int32 clusterID = 6;
    int32 replicaID = 7;
}

message ReadHistory {
    string key = 1;
    string value = 2;
    int64 version = 3;
    string responseDigest = 4;
    int32 clusterID = 5;
    int32 replicaID = 6;
}

message ROTransaction {
    repeated Read readOperations = 1;
}

message ROTransactionResponse {
    TransactionStatus status = 1;
    repeated ReadResponse readResponses = 2;
}

message Transaction {
    repeated ReadHistory readHistory = 1;
    repeated Write writeOperations = 2;
    string transactionID = 3;
    int32 epochNumber = 4;
    VectorClock clock = 5;
}

message TransactionResponse {
    TransactionStatus status = 1;
    repeated WriteResponse writeResponses = 2;
    string transactionID = 3;
    int32 epochNumber = 4;
    VectorClock clock = 5;
}

message DBData {
    string value = 1;
    int64 version = 2;
}

message MerkleTree {
    bytes root =1;
    repeated bytes nodes =2;
}

message VectorClock {
    repeated Timestamp timestamps = 1;
}

message Timestamp {
    int32 clusterID = 1;
    int32 epochNumber = 2;
}